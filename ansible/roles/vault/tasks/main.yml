- name: Check current Vault version
  shell:
    cmd: vault version | grep -oP '(?<=Vault v)([^ ]+)' || echo "none"
  register: installed_vault_version
  changed_when: false

- name: Install Vault {{ vault_version }}
  unarchive:
    src: https://releases.hashicorp.com/vault/{{ vault_version }}/vault_{{ vault_version }}_linux_arm64.zip
    dest: /usr/local/bin
    remote_src: true
  become: true
  when: installed_vault_version.stdout != vault_version
  register: install_vault

- name: Create Vault plugin directory
  file:
    state: directory
    path: /usr/local/libexec/vault
    owner: root
    group: root
    mode: 0755
  become: true

- name: Install Vault WebAuthn plugin
  copy:
    src: vault-plugin-auth-webauthn
    dest: /usr/local/libexec/vault/vault-plugin-auth-webauthn
    owner: root
    group: root
    mode: 0755
  become: true

- name: Install Vault config file
  copy:
    src: etc_vault.hcl
    dest: /etc/vault.hcl
  become: true
  register: config_file

- name: Install Vault systemd unit
  copy:
    src: vault.service
    dest: /usr/lib/systemd/system/vault.service
    mode: 0644
    owner: root
    group: root
  become: true
  register: systemd

- name: Enable and restart Vault service
  systemd:
    name: vault
    daemon_reload: true
    enabled: true
    state: restarted
  become: true
  when: install_vault.changed or systemd.changed

- name: Reload Vault service if needed
  systemd:
    name: vault
    state: reloaded
  become: true
  when: config_file.changed

- name: Ensure Vault service is started
  systemd:
    name: vault
    enabled: true
    state: started
  become: true
